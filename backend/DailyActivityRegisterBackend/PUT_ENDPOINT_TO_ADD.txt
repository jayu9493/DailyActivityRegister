# INSERT THIS BEFORE LINE 470 (before the backward compatibility section)

@app.put("/api/android/projects/{project_name}", response_model=ProjectResponse)
async def android_update_project(
    project_name: str,
    project_data: ProjectResponse,
    db: Session = Depends(get_db_session)
):
    """
    Update project from Android app - FIXED VERSION with proper persistence
    """
    try:
        logger.info(f"Updating project: {project_name}")
        db_project = ProjectRepository.get_project_by_name(db, project_name)
        if not db_project:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Project not found"
            )
        
        # Update fields from Pydantic model - use model_dump() instead of deprecated dict()
        data_dict = project_data.model_dump(exclude_unset=True)
        
        # Update simple fields
        for key, value in data_dict.items():
            if hasattr(db_project, key) and key not in ["tasks", "agencies", "created_at", "updated_at"]:
                setattr(db_project, key, value)
                
        # Update tasks specifically if present (handle JSON serialization)
        if "tasks" in data_dict:
            # Convert Pydantic models to dicts for JSON column
            tasks_data = [t.model_dump() if hasattr(t, 'model_dump') else (t.dict() if hasattr(t, 'dict') else t) for t in data_dict["tasks"]]
            db_project.tasks = tasks_data
            # Mark as modified so SQLAlchemy persists the change
            flag_modified(db_project, "tasks")
            
        # Update agencies
        if "agencies" in data_dict:
            agencies_data = [a.model_dump() if hasattr(a, 'model_dump') else (a.dict() if hasattr(a, 'dict') else a) for a in data_dict["agencies"]]
            db_project.agencies = agencies_data
            flag_modified(db_project, "agencies")
            
        # Use Python datetime instead of SQL function for updated_at
        db_project.updated_at = datetime.now()
        
        # Explicitly commit and refresh
        db.commit()
        db.refresh(db_project)
        logger.info(f"Project updated successfully: {project_name}")
        return clean_db_project(db_project)
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Android project update error: {e}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Could not update project: {str(e)}"
        )
